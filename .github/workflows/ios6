name: iOS Build and Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build iOS App
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Xcode
      uses: apple-actions/setup-xcode@v2
      with:
        xcode-version: '12.5' # Change to the version required for your project

    - name: Install dependencies
      run: |
        gem install cocoapods
        pod install

    - name: Build the project
      run: |
        xcodebuild clean build \
        -workspace YourApp.xcworkspace \
        -scheme YourAppScheme \
        -sdk iphonesimulator \
        -destination 'platform=iOS Simulator,name=iPhone 12,OS=14.5' # Use correct simulator version

    - name: Run unit tests
      run: |
        xcodebuild test \
        -workspace YourApp.xcworkspace \
        -scheme YourAppScheme \
        -destination 'platform=iOS Simulator,name=iPhone 12,OS=14.5' # Update this to your desired test device

    - name: Upload build artifact
      uses: actions/upload-artifact@v2
      with:
        name: iOS-App-Build
        path: |
          build/YourApp.app

  deploy:
    name: Deploy to Firebase (or other service)
    runs-on: macos-latest
    needs: build
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Firebase CLI
      run: curl -sL https://firebase.tools | bash

    - name: Deploy to Firebase App Distribution
      run: |
        firebase appdistribution:distribute build/YourApp.app \
          --app your-firebase-app-id \
          --groups "testers" \
          --token ${{ secrets.FIREBASE_TOKEN }}
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
